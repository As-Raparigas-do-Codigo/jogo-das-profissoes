name: Publish

on:
  push:
    branches: [ deploy ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

      # Instalação de pacotes
      - name: Atualiza pacotes
        run: sudo apt-get update
      - name: Instala o pacote 'davfs2'
        run: sudo apt-get -yq install davfs2
      - name: Instala o pacote 'git'
        run: sudo apt-get -yq install git

      # Clone do projecto
      - name: Clona o project
        run: git clone https://github.com/As-Raparigas-do-Codigo/jogo-das-profissoes.git

      # Monta o diretório
      - name: Escreve as credenciais do WebDav
        run: mkdir ~/.davfs2 && echo 'https://jogodasprofissoes.pt:2078 ${{ secrets.JDP_USER }} ${{ secrets.JDP_PWD }}' > ~/.davfs2/secrets
      - name: Altera as permissões do ficheiro de creds
        run: chmod 600 ~/.davfs2/secrets
      - name: Cria a pasta para conter o disco
        run: sudo mkdir -p /media/jogodasprofissoes && sudo chown -R runner:runner /media/jogodasprofissoes
      - name: Monta o disco
        run: sudo mount -t davfs https://jogodasprofissoes.pt:2078 /media/jogodasprofissoes

      #- name: Copia todos os ficheiros
      #  run: cp -vr ./jogodasprofissoes/ /mnt/jogodasprofissoes/